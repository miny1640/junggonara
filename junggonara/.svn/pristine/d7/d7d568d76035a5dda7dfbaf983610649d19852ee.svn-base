<%@page import="java.net.URLDecoder"%>
<%@page import="java.util.ArrayList"%>
<%@page import="exe.dao.BoardDAO"%>
<%@page import="exe.dao.CommentDAO"%>
<%@page import="exe.entity.CommentEntity"%>
<%@page import="exe.dao.MemberDAO"%>
<%@page import="exe.entity.DepartmentEntity"%>
<%@page import="exe.dao.DepartmentDAO"%>
<%@page import="exe.dao.BookDAO"%>
<%@page import="exe.entity.BookEntity"%>
<%@page import="exe.entity.MemberEntity"%>
<%@page import="exe.entity.BoardEntity"%>
<%@ page language="java" contentType="text/html; charset=EUC-KR"
	pageEncoding="EUC-KR"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="EUC-KR">
<%
	BoardEntity board = (BoardEntity)request.getAttribute("board");
%>
<title><%= board.getBr_title() %></title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/boardMainCSS.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src = "https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
<link rel = "stylesheet" href = "https://storage.googleapis.com/code.getmdl.io/1.0.6/material.indigo-pink.min.css">
<link rel = "stylesheet" href = "https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
td {
    background-color: #F2F2F2;
  }
</style>

</head>
<body>
<%
		MemberEntity member = (MemberEntity)session.getAttribute("member");
		String pg = request.getParameter("page");
		
	int curPage = 1;
	
	if (pg!= null){
		curPage = Integer.parseInt(pg);
		System.out.println("현재페이지 : "+curPage);
	}
	int scope = 15;
	int pageScope = 10;
	//Boardthree boardDAO select 참고
	int startNum = (curPage - 1) * scope + 1;
	CommentDAO comment_dao = new CommentDAO();
	MemberDAO member_dao = new MemberDAO();
	
	ArrayList<CommentEntity> list = new ArrayList<CommentEntity>();
	list  = comment_dao.select(board.getBr_num(),startNum, scope);
		
	
%>

<!-- 상단 바 -->
  <header class="mdl-layout__header mdl-layout__header--waterfall">
    <!-- Top row, always visible -->
    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title">
      <a href="boardMain.do"><img src = "image/main2.png" width="220" height="180" style="position:absolute; top:-45px; left:640px;"/></a>
      </span>
      <div class="mdl-layout-spacer"></div>
    </div>
    
<%
	if( member != null ){	
%>
    <!-- Bottom row, not visible on scroll -->
    <div class="mdl-layout__header-row">
      <div class="mdl-layout-spacer"></div>
      <!-- Navigation -->
      <nav class="mdl-navigation">
      <%=member.getMb_name() %>님
      <a class="mdl-navigation__link" href="logout.do">로그아웃</a>
      </nav>
    </div>
<%
	}else{
%>
	<!-- Bottom row, not visible on scroll -->
    <div class="mdl-layout__header-row">
      <div class="mdl-layout-spacer"></div>
      <!-- Navigation -->
      <nav class="mdl-navigation">
      <a class="mdl-navigation__link" href="loginForm.do">로그인</a>
      <a class="mdl-navigation__link" href="memberInsertForm.do">회원가입</a>
      </nav>
    </div>	
<%
	}
%>
  </header>
  <br/>
  <br/>

						<!-- 메인으로, 수정, 삭제 버튼 -->  
<div id="table under" style="position:absolute; top:145px; right:360px;">
				[<a href="boardMain.do">메인으로</a>]&nbsp;&nbsp;
<%
	if(board.getPurchase_done().equals("X")&&board.getMb_id() != member.getMb_id()){
		if(board.getSale_purchase().equals(" ")){
%>

<%
		}else if(board.getSale_purchase().equals("s")){//판매글이면 구매하기 버튼이 있어야하고
%>
				[<a href="purchase.do?br_num=<%=board.getBr_num() %>">구매하기</a>]&nbsp;&nbsp;
<%
		}else if(board.getSale_purchase().equals("p")){//구매글이면 판매하기 버튼이 있어야함.
%>
				[<a href="sale.do?br_num=<%=board.getBr_num() %>">판매하기</a>]&nbsp;&nbsp;<!-- 차후 기능구현해야할 부분 -->
<%
		}
	}else if(board.getPurchase_done().equals("O")&&board.getMb_id() == member.getMb_id()){
%>
				[<a href="tradeCancle.do?br_num=<%=board.getBr_num() %>">거래취소</a>]&nbsp;&nbsp;
<%
	}
	if(board.getMb_id() == member.getMb_id()){
%>
				[<a href="boardUpdateForm.do?br_num=<%=board.getBr_num() %>">수정</a>]&nbsp;&nbsp;
				[<a href="boardDelete.do?br_num=<%=board.getBr_num() %>">삭제</a>]
<%
	}
%>
</div>

						<!-- 날짜, 조회수 테이블 -->
<div style="position:absolute; top:145px; left:360px;">
	<table>
		<tr style="text-align:center;text-size:50pt;" height="10">
			<th>글번호&nbsp;</th>
			<td><%= board.getBr_num() %>&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<th>작성일&nbsp;</th>
			<td><%= board.getWrite_date() %>&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<th>조회수&nbsp;</th>
			<td><%= board.getHit() %></td>
		</tr>
	</table>
</div>

<div align="center" >
<table border="1" width="800" height="600">
		<tr style="text-align:center;"height="40" >
				<th colspan="2">제목</th>
				<td colspan="7"><%= board.getBr_title() %></td>
				<th>게시자</th>
<%
	MemberDAO memberDAO = new MemberDAO();
%>
				<td colspan="2"><%= memberDAO.select(board.getMb_id()).getMb_name() %></td><!-- 게시자 이름 출력 -->
				<th style="width:100px">판매/구입</th>
<%
	if(board.getSale_purchase().equals(" ")){
%>
				<td style="width:100px"></td>
<%
	}else if(board.getSale_purchase().equals("s")){
%>
				<td style="width:100px">판매글</td>
<%
	}else if(board.getSale_purchase().equals("p")){
%>
				<td style="width:100px">구입글</td>
<%
	}
	BookDAO bookDAO = new BookDAO();
	BookEntity book = bookDAO.selectBook(board.getBk_code());
	DepartmentDAO deptDAO = new DepartmentDAO();
	DepartmentEntity dept = deptDAO.selectDept(book.getDept_code());
%>
		</tr>
		<tr style="text-align:center;"height="40">
				<th colspan="2">책 이름</th>
<%
		if(book.getBk_title() == null){
%>
				<td colspan="7"></td>
<%
		}else{
%>
				<td colspan="7"><%= book.getBk_title() %></td><!-- 교제 이름 출력 -->
<%
		}
%>
				<th>학과</th>
<%
		if(dept.getDept_name() == null){
%>
				<td colspan="2"></td>
<%
		}else{
%>
				<td colspan="2"><%= dept.getDept_name() %></td><!-- 교제관련 학과 출력 -->
<%
		}
%>
				<th>가격</th>
				<td colspan="2"><%= board.getBr_price() %>원</td>
		</tr>	
		<tr style="text-align:center;">
				<th colspan="2">내용</th>
<%
		if(board.getBr_content() == null){
%>
				<td colspan="12">
<%
			if(board.getUpFile() == null){
%>
<%
			}else{
%>
					<img alt="" src="download/EMS영수증.jpg">
<%
			}
%>
				</td>
<%
		}else{
%>
				<td colspan="12">
<%
			if(board.getUpFile() == null){
%>
<%
			}else{
				System.out.println(board.getUpFile());
%>
					<img alt="" src="download/<%= board.getUpFile() %>"><br/>
<%
			}
%>
					<%= board.getBr_content().replaceAll("\n","<br/>") %>
				</td>	
<%
		}
%>
		</tr>
</table>

		
								<!-- 댓글 테이블 -->
<form action="boardReply.do" method="post">
	<table width="790" border="1">
		<tr>
             <th><input type="text" placeholder="댓글을 입력하세요. " name="comment" style="width:743px;height:40px;"/></th>
             <td><input type="submit" value="등록" style="width:50px;height:40px;"/></td>
        </tr>
	</table>
	<input type="hidden" name="br_num"  value="<%=board.getBr_num()%>"/>
</form>


<%
		if( list.size() > 0 ){
%>
<table class="mdl-shadow--2dp" width="800">
<%
			for(CommentEntity comment : list) {
				System.out.println("댓글 번호  : "+ comment.getCm_no());
%>
			<tr>
				<th><%= comment.getCm_no() %>&nbsp;&nbsp;<%= memberDAO.select(comment.getMb_id()).getMb_name() %></th> 		<!-- 댓글 번호 -->  <!-- 댓글 작성자 -->
				<th colspan="3" style="text-align: right;"><%= comment.getWrite_date() %></th> 	<!-- 댓글 작성날짜 -->
			</tr>
			<tr>
<%
			if(comment.getCm_content() == null){
%>
				<td colspan="2">&nbsp;<td>
<%
			}else{
%>
				<td colspan="2">&nbsp;&nbsp;&nbsp;&nbsp;<%= comment.getCm_content() %><td> 	<!-- 댓글 내용 -->
<%
			}
%>
				<td colspan="2" style="text-align: right;">
<%
		if(comment.getMb_id() == member.getMb_id()){
%>
					<a href="boardReplyDelete.do?br_num=<%=board.getBr_num() %>&cm_no=<%=comment.getCm_no() %>">
						삭제
					</a>
<%
		}
%>
				</td>
			</tr>
<%
			}
%>
</table>
 
<!--  페이지 넘버 -->
<%
	int cm_totalRow =comment_dao.cm_totalRow(board.getBr_num());
	System.out.println("게시물 갯수 : "+cm_totalRow);
	System.out.println("게시물 번호 : "+board.getBr_num());
	int totalPage = (cm_totalRow - 1) / scope + 1;
	System.out.println("총 나와야할 페이지 수  : "+ totalPage);
	//페이지 시작 번호
	int startPageNum = ((curPage-1) / pageScope) * pageScope + 1;
%>
<div class="list_number" style="position:relative;">
    <div>
        <div class="list_n_menu">
 <%
 		if (startPageNum>1){
 %>
 <a href="boardDetail.do?page=<%=1%>&br_num=<%=board.getBr_num() %>">◀◀</a> 
 <a href="boardDetail.do?page=<%=startPageNum - 1%>&br_num=<%=board.getBr_num() %>">◀ 이전 </a> 
<%
 		}
 		for (int i = startPageNum; i < (startPageNum + pageScope); i++){
 			if (i> totalPage) {
 				break;
 			}
 			if (curPage ==i){
%>
		<font color="red"><b>[ <%=i%> ]</b></font> 
<%
 			}else{
%>
 			[<a href="boardDetail.do?page=<%=i%>&br_num=<%=board.getBr_num() %>"><%=i%></a> ]
<%
 			}
 		}
 		if ( startPageNum + pageScope <= totalPage){
%>
		<a href="boardDetail.do?page=<%=startPageNum + pageScope%>&br_num=<%=board.getBr_num() %>">&gt;</a>
		<a href="boardDetail.do?page=<%=totalPage%>&br_num=<%=board.getBr_num() %>">&gt;&gt;</a> 
<%
 		}
%>
		</div>
	</div>
</div>
<%
		}else{ 
%>
<table class="mdl-shadow--2dp" width="800">
		<tr>
			<td>댓글이 없습니다.</td>
		</tr>
</table>	
<%
		}
%>
</div>
</body>
</html>